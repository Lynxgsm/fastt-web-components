{"version":3,"file":"chat-widget.js","sourceRoot":"","sources":["../../../src/components/chat-widget/chat-widget.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Env, h, Prop, State } from '@stencil/core';\nimport { callAIStream } from '../../utils/api-service';\nimport { generateConversationId } from '../../utils/utils';\nimport { marked } from 'marked';\n\n@Component({\n  tag: 'chat-widget',\n  styleUrl: 'chat-widget.css',\n  shadow: true,\n})\nexport class ChatWidget {\n  @State() messages: { role: string; content: string; isComplete?: boolean }[] = [];\n  @State() isLoading: boolean = false;\n  @State() isChatContainerVisible: boolean = true;\n  @Prop() apiEndpoint: string = Env.API_URL;\n  @State() conversationId: string = '';\n\n  private inputEl?: HTMLInputElement;\n\n  componentWillLoad() {\n    // Initialize conversation ID when component first loads\n    this.conversationId = generateConversationId();\n    console.log('Generated conversation ID:', this.conversationId);\n    this.loadFonts();\n\n    // Configure marked for safe rendering\n    marked.setOptions({\n      breaks: true, // Convert line breaks to <br>\n      gfm: true, // GitHub Flavored Markdown\n    });\n  }\n\n  private loadFonts() {\n    // Check if fonts are already loaded to avoid duplicates\n    const existingLink = document.querySelector('link[href*=\"fonts.googleapis.com/css2?family=Signika\"]');\n    if (!existingLink) {\n      const link = document.createElement('link');\n      link.rel = 'stylesheet';\n      link.href = 'https://fonts.googleapis.com/css2?family=Signika:wght@300..700&family=Yantramanav:wght@100;300;400;500;700;900&display=swap';\n      document.head.appendChild(link);\n    }\n  }\n\n  private handleSubmit = async (e: Event) => {\n    e.preventDefault();\n    const input = this.inputEl;\n    if (!input || !input.value.trim()) return;\n    const message = input.value;\n    const userMessage = { role: 'user', content: message, isComplete: true };\n    this.messages = [...this.messages, userMessage];\n    input.value = '';\n    this.isLoading = true;\n    const aiMessageIndex = this.messages.length;\n    this.messages = [...this.messages, { role: 'ai', content: '', isComplete: false }];\n    try {\n      await callAIStream(\n        message,\n        this.apiEndpoint,\n        this.conversationId,\n        (chunk: string) => {\n          const newMessages = [...this.messages];\n          newMessages[aiMessageIndex].content += chunk;\n          this.messages = newMessages;\n        },\n        () => {\n          this.isLoading = false;\n          const newMessages = [...this.messages];\n          newMessages[aiMessageIndex].isComplete = true;\n          this.messages = newMessages;\n        },\n        () => {\n          const newMessages = [...this.messages];\n          newMessages[aiMessageIndex] = {\n            ...newMessages[aiMessageIndex],\n            content: 'Sorry, I encountered an error. Please try again.',\n            isComplete: true,\n          };\n          this.messages = newMessages;\n          this.isLoading = false;\n        },\n      );\n    } catch (error) {\n      const newMessages = [...this.messages];\n      newMessages[aiMessageIndex] = {\n        ...newMessages[aiMessageIndex],\n        content: 'Sorry, I encountered an error. Please try again.',\n        isComplete: true,\n      };\n      this.messages = newMessages;\n      this.isLoading = false;\n    }\n  };\n\n  private toggleChatContainer = () => {\n    this.isChatContainerVisible = !this.isChatContainerVisible;\n  };\n\n  private setInputRef = (el: HTMLInputElement) => {\n    this.inputEl = el;\n  };\n\n  private renderMarkdown(content: string): string {\n    try {\n      // Sanitize the content to prevent XSS attacks\n      const sanitizedContent = content\n        .replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, '')\n        .replace(/<iframe\\b[^<]*(?:(?!<\\/iframe>)<[^<]*)*<\\/iframe>/gi, '')\n        .replace(/javascript:/gi, '')\n        .replace(/on\\w+\\s*=/gi, '');\n\n      // Handle both synchronous and asynchronous marked versions\n      const result = marked(sanitizedContent);\n      if (typeof result === 'string') {\n        // Add target=\"_blank\" to all links\n        return result.replace(/<a\\s+href=/gi, '<a target=\"_blank\" rel=\"noopener noreferrer\" href=');\n      } else {\n        // If it's a Promise, return a placeholder and handle it asynchronously\n        return sanitizedContent;\n      }\n    } catch (error) {\n      console.error('Error parsing markdown:', error);\n      // Fallback to plain text if markdown parsing fails\n      return content.replace(/</g, '&lt;').replace(/>/g, '&gt;');\n    }\n  }\n\n  render() {\n    return [\n      <div\n        class={{\n          'chat-widget-container': true,\n          'hide': !this.isChatContainerVisible,\n        }}\n      >\n        <div class=\"chat-header\">\n          <h3 class=\"chat-title\">Que puis-je faire pour vous ?</h3>\n          <button class=\"close-button\" onClick={this.toggleChatContainer}>\n            Ã—\n          </button>\n        </div>\n        <div class=\"message-container\">\n          {this.messages.map((message, index) => (\n            <div\n              key={index}\n              class={{\n                'message': true,\n                'user-message': message.role === 'user',\n                'ai-message': message.role === 'ai',\n              }}\n            >\n              {message.role === 'ai' ? (\n                <>\n                  {this.isLoading && message.content === '' ? (\n                    <chat-skeleton />\n                  ) : (\n                    <>\n                      <div class=\"markdown-content\" innerHTML={this.renderMarkdown(message.content)}></div>\n                      {message.isComplete && <satisfaction-buttons api-endpoint={this.apiEndpoint} conversation-id={this.conversationId} />}\n                    </>\n                  )}\n                </>\n              ) : (\n                <span>{message.content}</span>\n              )}\n            </div>\n          ))}\n        </div>\n        {/* <div class=\"typing-indicator\">\n          {this.isLoading ? 'AI is typing...' : ''}\n        </div> */}\n        <form class=\"input-container\" onSubmit={this.handleSubmit}>\n          <input type=\"text\" placeholder=\"Type a message...\" name=\"message\" required class=\"input\" ref={this.setInputRef} />\n          <button type=\"submit\" disabled={this.isLoading} class=\"send-button\">\n            {this.isLoading ? (\n              'Envoi...'\n            ) : (\n              <svg\n                class=\"send-icon\"\n                xmlns=\"http://www.w3.org/2000/svg\"\n                width=\"20\"\n                height=\"20\"\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"white\"\n                stroke-width=\"2\"\n                stroke-linecap=\"round\"\n                stroke-linejoin=\"round\"\n              >\n                <line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\"></line>\n                <polygon points=\"22 2 15 22 11 13 2 9 22 2\"></polygon>\n              </svg>\n            )}\n          </button>\n        </form>\n      </div>,\n      <button class=\"chat-toggler\" onClick={this.toggleChatContainer}>\n        <svg\n          xmlns=\"http://www.w3.org/2000/svg\"\n          width=\"24\"\n          height=\"24\"\n          viewBox=\"0 0 24 24\"\n          fill=\"none\"\n          stroke=\"white\"\n          stroke-width=\"2\"\n          stroke-linecap=\"round\"\n          stroke-linejoin=\"round\"\n        >\n          <path d=\"M7.9 20A9 9 0 1 0 4 16.1L2 22Z\" />\n        </svg>\n      </button>,\n    ];\n  }\n}\n"]}