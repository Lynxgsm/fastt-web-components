{"version":3,"file":"chat-modal.js","sourceRoot":"","sources":["../../../src/components/chat-modal/chat-modal.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, Host, h, State, Prop, Env } from '@stencil/core';\nimport { TitleStyle } from './types';\nimport { generateConversationId } from '../../utils/utils';\nimport { callAIStream } from '../../utils/api-service';\nimport { marked } from 'marked';\n\n@Component({\n  tag: 'chat-modal',\n  styleUrl: 'chat-modal.css',\n  shadow: true,\n})\nexport class ChatModal {\n  @State() open = true;\n  @Prop() modalTitle: string = \"Que puis-je faire pour vous ?\";\n  @Prop() titleStyle: Partial<TitleStyle> = {};\n  @State() messages: { role: string; content: string; isComplete?: boolean }[] = [];\n  @State() isLoading: boolean = false;\n  @Prop() iconSize: number = 16;\n  @Prop() apiEndpoint: string = Env.API_URL;\n  @State() conversationId: string = '';\n\n  componentWillLoad() {\n    this.conversationId = generateConversationId();\n    console.log('Generated conversation ID:', this.conversationId);\n    this.loadFonts();\n\n    // Configure marked for safe rendering\n    marked.setOptions({\n      breaks: true, // Convert line breaks to <br>\n      gfm: true,    // GitHub Flavored Markdown\n    });\n  }\n\n  private loadFonts() {\n    const existingLink = document.querySelector('link[href*=\"fonts.googleapis.com/css2?family=Signika\"]');\n    if (!existingLink) {\n      const link = document.createElement('link');\n      link.rel = 'stylesheet';\n      link.href = 'https://fonts.googleapis.com/css2?family=Signika:wght@300..700&family=Yantramanav:wght@100;300;400;500;700;900&display=swap';\n      document.head.appendChild(link);\n    }\n  }\n\n  private closeModal = () => {\n    this.open = false;\n  };\n\n  private handleChunk = async (message: string) => {\n    try {\n      const aiMessageIndex = this.messages.length - 1;\n\n      await callAIStream(\n        message,\n        this.apiEndpoint,\n        this.conversationId,\n        (chunk: string) => {\n          this.messages = this.messages.map((msg, index) =>\n            index === aiMessageIndex\n              ? { ...msg, content: msg.content + chunk }\n              : msg\n          );\n        },\n        () => {\n          this.messages = this.messages.map((msg, index) =>\n            index === aiMessageIndex\n              ? { ...msg, isComplete: true }\n              : msg\n          );\n          this.isLoading = false;\n        },\n        (error: Error) => {\n          console.error('AI stream error:', error);\n          this.messages = this.messages.map((msg, index) =>\n            index === aiMessageIndex\n              ? { ...msg, content: 'Sorry, I encountered an error. Please try again.', isComplete: true }\n              : msg\n          );\n          this.isLoading = false;\n        }\n      );\n    } catch (error) {\n      console.error('Failed to call AI stream:', error);\n      const aiMessageIndex = this.messages.length - 1;\n      this.messages = this.messages.map((msg, index) =>\n        index === aiMessageIndex\n          ? { ...msg, content: 'Sorry, I encountered an error. Please try again.', isComplete: true }\n          : msg\n      );\n      this.isLoading = false;\n    }\n  };\n\n  private handleSubmit = async (e: Event) => {\n    e.preventDefault();\n    const form = e.target as HTMLFormElement;\n    const input = form.querySelector('input[name=\"message\"]') as HTMLInputElement;\n    const message = input.value;\n    this.messages.push({ role: 'user', content: message });\n    this.isLoading = true;\n    form.reset();\n    this.messages.push({ role: 'ai', content: '' });\n    await this.handleChunk(message);\n  };\n\n  private renderMarkdown(content: string): string {\n    try {\n      // Sanitize the content to prevent XSS attacks\n      const sanitizedContent = content\n        .replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, '')\n        .replace(/<iframe\\b[^<]*(?:(?!<\\/iframe>)<[^<]*)*<\\/iframe>/gi, '')\n        .replace(/javascript:/gi, '')\n        .replace(/on\\w+\\s*=/gi, '');\n\n      // Handle both synchronous and asynchronous marked versions\n      const result = marked(sanitizedContent);\n      if (typeof result === 'string') {\n        return result;\n      } else {\n        // If it's a Promise, return a placeholder and handle it asynchronously\n        return sanitizedContent;\n      }\n    } catch (error) {\n      console.error('Error parsing markdown:', error);\n      // Fallback to plain text if markdown parsing fails\n      return content.replace(/</g, '&lt;').replace(/>/g, '&gt;');\n    }\n  }\n\n  render() {\n    return (\n      <Host>\n        <div class={{ 'modal-overlay': true, visible: this.open }}>\n          <div class=\"chat-container\">\n            <div class=\"modal-header\">\n              <span class=\"modal-title\">{this.modalTitle}</span>\n              <button class=\"close-button\" onClick={this.closeModal} aria-label=\"Close\">&times;</button>\n            </div>\n            <div class=\"chat-content\">\n              <div class=\"message-container\">\n                {this.messages.map((message, index) => (\n                  <div\n                    key={index}\n                    class={{\n                      'message': true,\n                      'user-message': message.role === 'user',\n                      'ai-message': message.role === 'ai',\n                    }}\n                  >\n                    {message.role === 'ai' ? (\n                      <>\n                        {this.isLoading && message.content === '' ? (\n                          <chat-skeleton />\n                        ) : (\n                          <div class=\"markdown-content\" innerHTML={this.renderMarkdown(message.content)}></div>\n                        )}\n                        {message.isComplete && <satisfaction-buttons />}\n                      </>\n                    ) : (\n                      <p>{message.content}</p>\n                    )}\n                  </div>\n                ))}\n              </div>\n              <form class=\"input-container\" onSubmit={this.handleSubmit}>\n                <input\n                  name='message'\n                  type='text'\n                  placeholder='Tapez votre message ici...'\n                  disabled={this.isLoading}\n                />\n                <button\n                  type='submit'\n                  disabled={this.isLoading}\n                  class=\"send-button\"\n                >\n                  {this.isLoading ? 'Envoi...' : <svg xmlns=\"http://www.w3.org/2000/svg\" width={this.iconSize} height={this.iconSize} viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" class=\"lucide lucide-send-horizontal-icon lucide-send-horizontal\"><path d=\"M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z\" /><path d=\"M6 12h16\" /></svg>}\n                </button>\n              </form>\n            </div>\n          </div>\n        </div>\n      </Host>\n    );\n  }\n}\n"]}